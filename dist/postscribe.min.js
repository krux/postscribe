/* Asynchronously write javascript, even with document.write., v1.0.2 https://github.com/krux/postscribe
Copyright (c) 2012 Derek Brans, MIT license https://github.com/krux/postscribe/blob/master/LICENSE */
(function(){function o(o,u){o=o||"",u=u||{};for(var a in e)e.hasOwnProperty(a)&&(u.autoFix&&(u["fix_"+a]=!0),u.fix=u.fix||u["fix_"+a]);var f=[],l=function(e){o+=e},c=function(e){o=e+o},h={comment:/^<!--/,endTag:/^<\//,atomicTag:/^<\s*(script|style|noscript)[\s>]/i,startTag:/^</,chars:/^[^<]/},p={comment:function(){var e=o.indexOf("-->");if(e>=0)return{content:o.substr(4,e),length:e+3}},endTag:function(){var e=o.match(n);if(e)return{tagName:e[1],length:e[0].length}},atomicTag:function(){var e=p.startTag();if(e){var t=o.slice(e.length),n=t.match("([\\s\\S]*?)</"+e.tagName+"[^>]*>");if(n)return{tagName:e.tagName,attrs:e.attrs,escapedAttrs:e.escapedAttrs,content:n[1],length:n[0].length+e.length}}},startTag:function(){var e=o.match(t);if(e){var n={},s={};return e[2].replace(r,function(e,t){var r=arguments[2]||arguments[3]||arguments[4]||i.test(t)&&t||null;n[t]=r,s[t]=r&&r.replace(/(^|[^\\])"/g,'$1\\"')}),{tagName:e[1],attrs:n,escapedAttrs:s,unary:e[3],length:e[0].length}}},chars:function(){var e=o.indexOf("<");return{length:e>=0?e:o.length}}},d=function(){for(var e in h)if(h[e].test(o)){s&&console.log("suspected "+e);var t=p[e]();return t?(s&&console.log("parsed "+e,t),t.type=t.type||e,t.text=o.substr(0,t.length),o=o.slice(t.length),t):null}},v=function(e){var t;while(t=d())if(e[t.type]&&e[t.type](t)===!1)return},m=function(){var e=o;return o="",e},g=function(){return o};return u.fix&&function(){var e=/^(AREA|BASE|BASEFONT|BR|COL|FRAME|HR|IMG|INPUT|ISINDEX|LINK|META|PARAM|EMBED)$/i,t=/^(ADDRESS|APPLET|BLOCKQUOTE|BUTTON|CENTER|DD|DEL|DIR|DIV|DL|DT|FIELDSET|FORM|FRAMESET|HR|IFRAME|INS|ISINDEX|LI|MAP|MENU|NOFRAMES|NOSCRIPT|OBJECT|OL|P|PRE|SCRIPT|TABLE|TBODY|TD|TFOOT|TH|THEAD|TR|UL)$/i,n=/^(A|ABBR|ACRONYM|APPLET|B|BASEFONT|BDO|BIG|BR|BUTTON|CITE|CODE|DEL|DFN|EM|FONT|I|IFRAME|IMG|INPUT|INS|KBD|LABEL|MAP|OBJECT|Q|S|SAMP|SCRIPT|SELECT|SMALL|SPAN|STRIKE|STRONG|SUB|SUP|TEXTAREA|TT|U|VAR)$/i,r=/^(COLGROUP|DD|DT|LI|OPTIONS|P|TD|TFOOT|TH|THEAD|TR)$/i,i=[];i.last=function(){return this[this.length-1]},i.lastTagNameEq=function(e){var t=this.last();return t&&t.tagName&&t.tagName.toUpperCase()===e.toUpperCase()},i.containsTagName=function(e){for(var t=0,n;n=this[t];t++)if(n.tagName===e)return!0;return!1};var s=function(t){return t&&t.type==="startTag"&&(t.unary=e.test(t.tagName)||t.unary),t},a=d,f=function(){var e=o,t=s(a());return o=e,t},l=function(){var e=i.pop();c("</"+e.tagName+">")},h={startTag:function(e){var t=e.tagName;t.toUpperCase()==="TR"&&i.lastTagNameEq("TABLE")?(c("<TBODY>"),v()):u.fix_selfClose&&r.test(t)&&i.containsTagName(t)?i.lastTagNameEq(t)?l():(c("</"+e.tagName+">"),v()):e.unary||i.push(e)},endTag:function(e){var t=i.last();t?u.fix_tagSoup&&!i.lastTagNameEq(e.tagName)?l():i.pop():u.fix_tagSoup&&p()}},p=function(){a(),v()},v=function(){var e=f();e&&h[e.type]&&h[e.type](e)};d=function(){return v(),s(a())}}(),{append:l,readToken:d,readTokens:v,clear:m,rest:g,stack:f}}var e=function(){var e={},t,n,r=document.createElement("div");return t="<P><I></P></I>",r.innerHTML=t,e.tagSoup=r.innerHTML!==t,r.innerHTML="<P><i><P></P></i></P>",e.selfClose=r.childNodes.length===2,e}(),t=/^<([\-A-Za-z0-9_]+)((?:\s+[\w-]+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)>/,n=/^<\/([\-A-Za-z0-9_]+)[^>]*>/,r=/([\-A-Za-z0-9_]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+)))?/g,i=/^(checked|compact|declare|defer|disabled|ismap|multiple|nohref|noresize|noshade|nowrap|readonly|selected)$/i,s=!1;o.supports=e,o.tokenToString=function(e){var t={comment:function(e){return"<--"+e.content+"-->"},endTag:function(e){return"</"+e.tagName+">"},atomicTag:function(e){return console.log(e),t.startTag(e)+e.content+t.endTag(e)},startTag:function(e){var t="<"+e.tagName;for(var n in e.attrs){var r=e.attrs[n];t+=" "+n+'="'+(r?r.replace(/(^|[^\\])"/g,'$1\\"'):"")+'"'}return t+(e.unary?"/>":">")},chars:function(e){return e.text}};return t[e.type](e)};for(var u in e)o.browserHasFlaw=o.browserHasFlaw||!e[u]&&u;this.htmlParser=o})(),function(){function i(){}function s(e){return"function"==typeof e}function o(e,t,n){var r,i=e&&e.length||0;for(r=0;r<i;r++)t.call(n,e[r],r)}function u(e,t,n){var r;for(r in e)e.hasOwnProperty(r)&&t.call(n,r,e[r])}function a(e){var t=r.call(arguments,1);return o(t,function(t){u(t,function(t,n){e[t]=n})}),e}function f(e,t){return e=e||{},u(t,function(t,n){e.hasOwnProperty(t)&&n!==undefined&&(e[t]=n)}),e}function l(e){try{return r.call(e)}catch(t){var n=[];return o(e,function(e){n.push(e)}),n}}function c(e){return/^script$/i.test(e.tagName)}var e=this;if(e.postscribe)return;var t=!0,n=!1,r=Array.prototype.slice,h=function(){function t(t,n,r){var i=e+n;if(arguments.length===2){var s=t.getAttribute(i);return s==null?s:String(s)}r!=null&&r!==""?t.setAttribute(i,r):t.removeAttribute(i)}function r(e){this.actuals=[e],this.proxyHistory="",this.proxyRoot=e.ownerDocument.createElement(e.nodeName),t(this.proxyRoot,"proxyof",0)}var e="data-ps-";return r.prototype.buildChunk=function(t){var n=this.actuals.length,r=[],i=[],s=[];return o(t,function(t){r.push(t.text);if(t.attrs){if(!/^noscript$/i.test(t.tagName)){var o=n++;i.push(t.text.replace(/(\/?>)/," "+e+"id="+o+" $1")),s.push(t.type==="atomicTag"?"":"<"+t.tagName+" "+e+"proxyof="+o+(t.unary?"/>":">"))}}else i.push(t.text),s.push(t.type==="endTag"?t.text:"")}),{tokens:t,raw:r.join(""),actual:i.join(""),proxy:s.join("")}},r.prototype.write=function(e){var t=this.buildChunk(e);if(!t.actual)return;return t.html=this.proxyHistory+t.actual,this.proxyHistory+=t.proxy,this.proxyRoot.innerHTML=t.html,n&&(t.proxyInnerHTML=this.proxyRoot.innerHTML),this.walkNodes(),n&&(t.actualInnerHTML=this.actuals[0].innerHTML),t},r.prototype.walkNodes=function(){var e,n=[this.proxyRoot];while((e=n.shift())!=null){var r=e.nodeType===1,i=r&&t(e,"proxyof");if(!i){r&&(this.actuals[t(e,"id")]=e,t(e,"id",null));var s=e.parentNode&&t(e.parentNode,"proxyof");s&&this.actuals[s].appendChild(e)}n.unshift.apply(n,l(e.childNodes))}},r}(),p=function(){function t(t){this.root=t,this.stream=new h(this.root),this.parser=e.htmlParser("",{autoFix:!0});var n=this.doc=this.root.ownerDocument,r=this.win=n.defaultView||n.parentWindow;r.execScript&&!r.eval&&r.execScript("0")}return t.prototype.exec=function(e,t){e.run.call(this.win,this.doc),delete e.run,t()},t.prototype.script_inline=function(e,t){try{this.win.eval(e.expr)}catch(n){}t()},t.prototype.script_remote=function(e,t){var n=this.doc.createElement("script"),r=function(){n=n.onload=n.onreadystatechange=n.onerror=null,t()};n.onload=n.onreadystatechange=function(){(!n.readyState||/^(loaded|complete)$/.test(n.readyState))&&r()};var i=this.options;n.onerror=function(){i.error({message:"remote script failed "+e.src}),r()},n.src=e.src,this.root.parentNode.appendChild(n)},t.prototype.write=function(e,t,r){this.parser.append(e.html);var i,s=[];while((i=this.parser.readToken())!=null&&!c(i))s.push(i);var o=this.stream.write(s);n&&(e.chunk=o),i&&this.onScriptToken(i,r),t()},t.prototype.onScriptToken=function(e,t){var n=this.parser.clear(),r=e.attrs.src||e.attrs.SRC;t.subtask(r?{type:"script_remote",src:r}:{type:"script_inline",inlinable:!0,expr:e.content.replace(/<!\[CDATA\[([\s\S]*?)\]\]>/g,"$1").replace(/<!--([\s\S]*?)-->/g,"$1")}),n&&t.subtask({type:"write",html:n,inlinable:!0})},t}(),d=function(){function e(e,t){this.worker=e,this.options=t=t||{},t.taskAdd=t.taskAdd||i,t.taskStart=t.taskStart||i,t.taskDone=t.taskDone||i,this.stopRequested=!0,this.active=null,this.deferred=[],this._deferred=this.deferred}return e.prototype.task=function(e,t){return this.options.taskAdd(e),this.deferred.push(e,t||i),this.nextIfIdle(),this},e.prototype.subtask=function(e){this.options.taskAdd(e),e.inlinable&&!this._deferred.length?this.startTask(e):this._deferred.push(e)},e.prototype.startTask=function(e){var t=this;if(this.stopRequested)return this._deferred.unshift(e);if(s(e))return e.call(this),this.nextIfIdle();var n={active:this.active,_deferred:this._deferred};a(this,{active:e,_deferred:[]}),this.options.taskStart(e),this.worker[e.type](e,function(){t.doneTask(n)},this)},e.prototype.doneTask=function(e){this.options.taskDone(this.active),[].unshift.apply(e._deferred,this._deferred),a(this,e),this.onStop&&!this.active&&(this.onStop(),delete this.onStop),this.nextIfIdle()},e.prototype.nextIfIdle=function(){var e=!this.active&&this.deferred.shift();e&&this.startTask(e)},e.prototype.stop=function(e){e=e||i,this.stopRequested=!0,this.active?this.onStop=e:e()},e.prototype.start=function(){return this.stopRequested=!1,delete this.onStop,this.nextIfIdle(),this},e}(),v=function(){function e(){this.tasks=[],this.roots=[],this.active=null}return e.prototype.taskAdd=function(e){return e.id=this.tasks.length,this.tasks.push(e),e.state="waiting",this.active&&(e.cause=this.active.id,(this.active.effects=this.active.effects||[]).push(e.id)),e},e.prototype.taskStart=function(e){var t=this.active;t?(e.parent=t.id,(t.childIds=t.childIds||[]).push(e.id),(t.children=t.children||[]).push(e)):this.roots.push(e),e.state="started",this.active=e},e.prototype.taskDone=function(e){e.state="done",this.active=e.parent!=null?this.tasks[e.parent]:null},e}(),m=function(){function n(e,n,r,i){function c(e){u.subtask({type:"write",html:e,inlinable:!0}),r.afterWrite&&r.afterWrite(e)}var s=new p(e),u=new d(s,t&&new v);u.name=r.name,o.writers[u.name]=u;var f=e.ownerDocument,l={write:f.write,writeln:f.writeln};return a(f,{write:c,writeln:function(e){c(e+"\n")}}),u.task(n,function(){a(f,l),r.done&&r.done(),i()}).start()}function o(t,n,o){t=/^#/.test(t)?e.document.getElementById(t.substr(1)):t.jquery?t[0]:t,o=o||{};var u=s(n)?{type:"exec",run:n}:{type:"write",html:n},f=a([t,u,o],{type:"rootTask"});return r.task(f),t.postscribe={stop:function(){f.flow?f.flow.stop():f[1]={type:"exec",run:i}}}}var r=(new d({rootTask:function(e,t){e.push(t),e.flow=n.apply(null,e)}})).start();return a(o,{writers:{},queue:r})}();e.postscribe=m}();