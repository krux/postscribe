/* Asynchronously write javascript, even with document.write., v1.0.4 https://github.com/krux/postscribe
Copyright (c) 2013 Derek Brans, MIT license https://github.com/krux/postscribe/blob/master/LICENSE */
(function(){function o(o,u){function p(e){return p[e]||(p[e]=new RegExp("([\\s\\S]*?)</\\s*"+e+"\\s*>","i"))}o=o||"",u=u||{};for(var a in e)e.hasOwnProperty(a)&&(u.autoFix&&(u["fix_"+a]=!0),u.fix=u.fix||u["fix_"+a]);var f=[],l=function(e){o+=e},c=function(e){o=e+o},h={comment:/^<!--/,endTag:/^<\//,atomicTag:/^<\s*(script|style|noscript)[\s>]/i,startTag:/^</,chars:/^[^<]/},d={comment:function(){var e=o.indexOf("-->");if(e>=0)return{content:o.substr(4,e),length:e+3}},endTag:function(){var e=o.match(n);if(e)return{tagName:e[1],length:e[0].length}},atomicTag:function(){var e=d.startTag();if(e){var t=o.slice(e.length);if(t.match(new RegExp("</\\s*"+e.tagName+"\\s*>","i"))){var n=t.match(new RegExp("([\\s\\S]*?)</\\s*"+e.tagName+"\\s*>","i"));if(n)return{tagName:e.tagName,attrs:e.attrs,content:n[1],length:n[0].length+e.length}}}},startTag:function(){var e=o.match(t);if(e){var n={};return e[2].replace(r,function(e,t){var r=arguments[2]||arguments[3]||arguments[4]||i.test(t)&&t||null;n[t]=r}),{tagName:e[1],attrs:n,unary:!!e[3],length:e[0].length}}},chars:function(){var e=o.indexOf("<");return{length:e>=0?e:o.length}}},v=function(){for(var e in h)if(h[e].test(o)){s&&console.log("suspected "+e);var t=d[e]();return t?(s&&console.log("parsed "+e,t),t.type=t.type||e,t.text=o.substr(0,t.length),o=o.slice(t.length),t):null}},m=function(e){var t;while(t=v())if(e[t.type]&&e[t.type](t)===!1)return},g=function(){var e=o;return o="",e},y=function(){return o};return u.fix&&function(){var e=/^(AREA|BASE|BASEFONT|BR|COL|FRAME|HR|IMG|INPUT|ISINDEX|LINK|META|PARAM|EMBED)$/i,t=/^(ADDRESS|APPLET|BLOCKQUOTE|BUTTON|CENTER|DD|DEL|DIR|DIV|DL|DT|FIELDSET|FORM|FRAMESET|HR|IFRAME|INS|ISINDEX|LI|MAP|MENU|NOFRAMES|NOSCRIPT|OBJECT|OL|P|PRE|SCRIPT|TABLE|TBODY|TD|TFOOT|TH|THEAD|TR|UL)$/i,n=/^(A|ABBR|ACRONYM|APPLET|B|BASEFONT|BDO|BIG|BR|BUTTON|CITE|CODE|DEL|DFN|EM|FONT|I|IFRAME|IMG|INPUT|INS|KBD|LABEL|MAP|OBJECT|Q|S|SAMP|SCRIPT|SELECT|SMALL|SPAN|STRIKE|STRONG|SUB|SUP|TEXTAREA|TT|U|VAR)$/i,r=/^(COLGROUP|DD|DT|LI|OPTIONS|P|TD|TFOOT|TH|THEAD|TR)$/i,i=[];i.last=function(){return this[this.length-1]},i.lastTagNameEq=function(e){var t=this.last();return t&&t.tagName&&t.tagName.toUpperCase()===e.toUpperCase()},i.containsTagName=function(e){for(var t=0,n;n=this[t];t++)if(n.tagName===e)return!0;return!1};var s=function(t){return t&&t.type==="startTag"&&(t.unary=e.test(t.tagName)||t.unary),t},a=v,f=function(){var e=o,t=s(a());return o=e,t},l=function(){var e=i.pop();c("</"+e.tagName+">")},h={startTag:function(e){var t=e.tagName;t.toUpperCase()==="TR"&&i.lastTagNameEq("TABLE")?(c("<TBODY>"),d()):u.fix_selfClose&&r.test(t)&&i.containsTagName(t)?i.lastTagNameEq(t)?l():(c("</"+e.tagName+">"),d()):e.unary||i.push(e)},endTag:function(e){var t=i.last();t?u.fix_tagSoup&&!i.lastTagNameEq(e.tagName)?l():i.pop():u.fix_tagSoup&&p()}},p=function(){a(),d()},d=function(){var e=f();e&&h[e.type]&&h[e.type](e)};v=function(){return d(),s(a())}}(),{append:l,readToken:v,readTokens:m,clear:g,rest:y,stack:f}}var e=function(){var e={},t,n,r=document.createElement("div");return t="<P><I></P></I>",r.innerHTML=t,e.tagSoup=r.innerHTML!==t,r.innerHTML="<P><i><P></P></i></P>",e.selfClose=r.childNodes.length===2,e}(),t=/^<([\-A-Za-z0-9_]+)((?:\s+[\w-]+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*)\s*(\/?)>/,n=/^<\/([\-A-Za-z0-9_]+)[^>]*>/,r=/([\-A-Za-z0-9_]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|([^>\s]+)))?/g,i=/^(checked|compact|declare|defer|disabled|ismap|multiple|nohref|noresize|noshade|nowrap|readonly|selected)$/i,s=!1;o.supports=e,o.tokenToString=function(e){var t={comment:function(e){return"<--"+e.content+"-->"},endTag:function(e){return"</"+e.tagName+">"},atomicTag:function(e){return console.log(e),t.startTag(e)+e.content+t.endTag(e)},startTag:function(e){var t="<"+e.tagName;for(var n in e.attrs){var r=e.attrs[n];t+=" "+n+'="'+(r?r.replace(/(^|[^\\])"/g,'$1\\"'):"")+'"'}return t+(e.unary?"/>":">")},chars:function(e){return e.text}};return t[e.type](e)},o.escapeAttributes=function(e){var t={};for(var n in e){var r=e[n];t[n]=r&&r.replace(/(^|[^\\])"/g,'$1\\"')}return t};for(var u in e)o.browserHasFlaw=o.browserHasFlaw||!e[u]&&u;this.htmlParser=o})(),function(){function i(){}function s(e){return"function"==typeof e}function o(e,t,n){var r,i=e&&e.length||0;for(r=0;r<i;r++)t.call(n,e[r],r)}function u(e,t,n){var r;for(r in e)e.hasOwnProperty(r)&&t.call(n,r,e[r])}function a(e,t){return u(t,function(t,n){e[t]=n}),e}function f(e,t){return e=e||{},u(t,function(t,n){e[t]==null&&(e[t]=n)}),e}function l(e){try{return r.call(e)}catch(t){var n=[];return o(e,function(e){n.push(e)}),n}}function c(e){return/^script$/i.test(e.tagName)}var e=this;if(e.postscribe)return;var t=!0,n=!1,r=Array.prototype.slice,h=function(){function t(t,n,r){var i=e+n;if(arguments.length===2){var s=t.getAttribute(i);return s==null?s:String(s)}r!=null&&r!==""?t.setAttribute(i,r):t.removeAttribute(i)}function r(e){this.actuals=[e],this.proxyHistory="",this.proxyRoot=e.ownerDocument.createElement(e.nodeName),t(this.proxyRoot,"proxyof",0)}var e="data-ps-";return r.prototype.buildChunk=function(t){var n=this.actuals.length,r=[],i=[],s=[];return o(t,function(t){r.push(t.text);if(t.attrs){if(!/^noscript$/i.test(t.tagName)){var o=n++;i.push(t.text.replace(/(\/?>)/," "+e+"id="+o+" $1")),s.push(t.type==="atomicTag"?"":"<"+t.tagName+" "+e+"proxyof="+o+(t.unary?"/>":">"))}}else i.push(t.text),s.push(t.type==="endTag"?t.text:"")}),{tokens:t,raw:r.join(""),actual:i.join(""),proxy:s.join("")}},r.prototype.write=function(e){var t=this.buildChunk(e);if(!t.actual)return;return t.html=this.proxyHistory+t.actual,this.proxyHistory+=t.proxy,this.proxyRoot.innerHTML=t.html,n&&(t.proxyInnerHTML=this.proxyRoot.innerHTML),this.walkNodes(),n&&(t.actualInnerHTML=this.actuals[0].innerHTML),t},r.prototype.walkNodes=function(){var e,n=[this.proxyRoot];while((e=n.shift())!=null){var r=e.nodeType===1,i=r&&t(e,"proxyof");if(!i){r&&(this.actuals[t(e,"id")]=e,t(e,"id",null));var s=e.parentNode&&t(e.parentNode,"proxyof");s&&this.actuals[s].appendChild(e)}n.unshift.apply(n,l(e.childNodes))}},r}(),p=function(){function t(t,n){var r=t.ownerDocument;a(this,{root:t,options:f(n,{error:i}),stream:new h(t),parser:e.htmlParser("",{autoFix:!0}),doc:r,win:r.defaultView||r.parentWindow})}t.prototype.exec=function(e,t){e.run.call(this.win,this.doc),delete e.run,t()};var r=e.execScript?"execScript":"eval";return t.prototype.script_inline=function(e,t){try{this.win[r](e.expr)}catch(n){this.options.error(n)}t()},t.prototype.script_remote=function(e,t){var n=this,r=this.doc.createElement("script"),i={src:e.src,async:!0,onload:function(){r=r.onload=r.onreadystatechange=r.onerror=null,t()},onreadystatechange:function(){/^(loaded|complete)$/.test(r.readyState)&&r.onload()},onerror:function(){n.options.error({message:"remote script failed "+e.src}),r.onload()}};u(e.tok.attrs,function(e,t){i.hasOwnProperty(e)||r.setAttribute(e,t)}),a(r,i),this.root.appendChild(r)},t.prototype.write=function(e,t,r){this.parser.append(e.html);var i,s=[];while((i=this.parser.readToken())!=null&&!c(i))s.push(i);var o=this.stream.write(s);n&&(e.chunk=o),i&&this.onScriptToken(i,r),t()},t.prototype.onScriptToken=function(e,t){var n=this.parser.clear(),r=e.attrs.src||e.attrs.SRC;t.subtask(r?{type:"script_remote",src:r,tok:e}:{type:"script_inline",inlinable:!0,tok:e,expr:e.content.replace(/<!\[CDATA\[([\s\S]*?)\]\]>/g,"$1").replace(/<!--([\s\S]*?)-->/g,"$1")}),n&&t.subtask({type:"write",html:n,inlinable:!0})},t}(),d=function(){function e(e,t){var n=[];a(this,{worker:e,options:f(t,{taskAdd:i,taskStart:i,taskDone:i}),active:null,deferred:n,_deferred:n})}return e.prototype.task=function(e,t){return this.options.taskAdd(e),this.deferred.push(e),t&&this.deferred.push(t),this.nextIfIdle(),this},e.prototype.subtask=function(e){this.options.taskAdd(e),e.inlinable&&!this._deferred.length?this.startTask(e):this._deferred.push(e)},e.prototype.startTask=function(e){var t=this;if(this.stopRequested)return this._deferred.unshift(e);if(s(e))return e.call(this),this.nextIfIdle();var n={active:this.active,_deferred:this._deferred};a(this,{active:e,_deferred:[]}),this.options.taskStart(e),this.worker[e.type](e,function(){t.doneTask(n)},this)},e.prototype.doneTask=function(e){this.options.taskDone(this.active),[].unshift.apply(e._deferred,this._deferred),a(this,e),this.onStop&&!this.active&&(this.onStop(),delete this.onStop),this.nextIfIdle()},e.prototype.nextIfIdle=function(){var e=!this.active&&this.deferred.shift();e&&this.startTask(e)},e.prototype.stop=function(e){e=e||i,this.stopRequested=!0,this.active?this.onStop=e:e()},e.prototype.start=function(){return this.stopRequested=!1,delete this.onStop,this.nextIfIdle(),this},e}(),v=function(){function e(){a(this,{tasks:[],roots:[],active:null})}return e.prototype.taskAdd=function(e){return e.id=this.tasks.length,this.tasks.push(e),e.state="waiting",this.active&&(e.cause=this.active.id,(this.active.effects=this.active.effects||[]).push(e.id)),e},e.prototype.taskStart=function(e){var t=this.active;t?(e.parent=t.id,(t.childIds=t.childIds||[]).push(e.id),(t.children=t.children||[]).push(e)):this.roots.push(e),e.state="started",this.active=e},e.prototype.taskDone=function(e){e.state="done",this.active=e.parent!=null?this.tasks[e.parent]:null},e}(),m=function(){function r(e,r,s,o){function g(e){c.subtask({type:"write",html:e,inlinable:!0}),s.afterWrite(e)}s=f(s,{afterWrite:i,done:i});var u=new p(e,s),c=new d(u,t&&new v);c.id=n++,c.name=s.name||c.id,l.flows[c.name]=c;var h=e.ownerDocument,m={write:h.write,writeln:h.writeln};return a(h,{write:g,writeln:function(e){g(e+"\n")}}),c.task(r,function(){a(h,m),s.done(),o()}),c}function l(t,n,r){t=/^#/.test(t)?e.document.getElementById(t.substr(1)):t.jquery?t[0]:t,r=r||{};var u=s(n)?{type:"exec",run:n}:{type:"write",html:n},f=a([t,u,r],{type:"rootTask"});return o.task(f),t.postscribe={stop:function(){f.flow?f.flow.stop():f[1]={type:"exec",run:i}}}}var n=0,o=new d({rootTask:function(e,t){e.push(t),e.flow=r.apply(null,e)}});return a(l,{flows:{},queue:o,Worker:p,Flow:d,Tracer:v,WriteStream:h,json:function(){var e={};return u(this.flows,function(t,n){e[t]=n.options.roots}),e}})}();e.postscribe=m}();