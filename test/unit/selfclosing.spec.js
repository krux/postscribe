import * as wc from '../helpers/write-comparor';
import {Html} from '../helpers/write-thunks';

const sampleBid = {
  "adid": "1333079",
  "adm": "<script>!function(e,t){for(var m=0;m<e.length;m++)(new Image).src=e[m]}([\"https://got.pubnative.net/impression?aid=1656863&t=nrrYINQ84KMjAOpbtc6pJ0UtFmH9n4q0aFDwFU2GvNL14hD7NeA4x4MHqAjY7-og250YcSgeS080tJ8g6TAveJHF26a7MosilgRBQNHnkp8ZemfiInsxz7XQPDB1vXghHmyhyvP5MfX2sZ0Mi82GscdQ7WsDF4vWri3yBrQeKs4rqBbydiXa3NCf7Vxm21drh_AcE_GtZWQ06DYeh2quaV3Yq0BxWhz2ypRsPJH0rDqSh7qQg3Mwu8iZTUxMMmztLFLwm0702RdpB6rGSgoB979T7mIeabJseBjzDy_nOAOdphSMcve2Gy0TeNRR4Vsn5UlgdFodFtziHwHWNi-ghtgHSAFseMajNF9K9miJOek7xFsHtxfmh49SvelQ8JpEZK6_FeiG41dliH8ER4Yo-CvDPs7CJA5UQ4xThouAjd8cf1_eEckW5RVTM8drEzVGryD0bCUq5zfdZNQbMMwD9TUwKYZ0dRMaYOSvbbKk0cLxyMSdcqp2SR0oC-L_ZmiDRdWBmiVm5NL6XMIpC_Dh3rV2V2SrmWHqz_K7zKDQHShHuhOEchFwfsxLyLbRoO5aTMPJP9DXeUTcoAq8Az1fKnk8yEJFaDfkXqxSTeG8tAYKcA9zT_GdMyQ97aVBHUuxZGvF5hYQe1cqtVn_LTNY_7f1bYhiR_GG-8OYuNgHPiVXQW56nIvua0abSD2RBdbtaOWELuyHifinQtWPkIFnGmAyujTsWROFBI7-FoiwYLOFke6o3blbvH0eQrCBCJm_swMbMkoygvIy3285vxj_6aOHMQmVEneLMOwreAbcwM_yoUoN-EWfG4C2gqenQJhDjL0mwI6cS_ONQZnK3jjdnz4sACjAg7GT592tDdk02TenUgSci6ns6xp_ip9S8oVjxY2YxmKX7Xg4JS1H5jZZi13HeoclGjX31Is-x7Vc9ca5v7s-dH1WdMnU5fNS6QmmhiHNx0fXQg12F7YX2McCakSpoiiuqXHcVQbJFXsUdtsrmdsFo0mU7mjyghCUNGKKHGI5arDe0rvO7bTH5ITFF-OY4Z26bH2jatq8jvv8zqdY&ap=${AUCTION_PRICE}\",\"https://q.adrta.com/s/pn/aa.js?cb=[CB]#pn;paid=pn;avid=460;caid=40_2419;kv1=300x250;kv11=cd696e39-a281-406c-9e51-c6126579522d;kv12=1656863-1-630182;kv16=40.694000;kv17=-73.990100;kv18=397648381;kv19=FD18721D-B47D-4E25-BF48-A5FB8D94376A;kv2=https%3A%2F%2Fitunes.apple.com%2FUS%2Fapp%2Fid397648381%3Fmt%3D8%26uo%3D4;kv24=Mobile_InApp_Banner;kv27=Mozilla%2F5.0+%28iPhone%3B+CPU+iPhone+OS+13_3_1+like+Mac+OS+X%29+AppleWebKit%2F605.1.15+%28KHTML%2C+like+Gecko%29+Mobile%2F15E148;kv28=iPhone9%2C4;kv3=FD18721D-B47D-4E25-BF48-A5FB8D94376A;kv4=108.41.31.222;plid=40_1333079;publisherId=1007333;siteId=1656863\"],\"https://got.pubnative.net/imp/error?t=7qVrqmNowzrZArJ5Ln2QtzuKZ-uA1MhHKlGXSUpktQpQ3CSTIaKHvrziYoBdRz4SuLHb8q8srW-W5RlZEBV7xpMQsLDhBeBkW2Fiokdt7UrGR1BzlLdejdq6bHYVNb1qE_nNRtdt4aqsrxYtKcm9zY755oEwPqRyEiK0WKPWeTPHl4nZmX0&msg=\");</script><div id=\"grumi-container\"><script type=\"text/javascript\" nonce=\"!headerNonce!\">!function(d,i){var s={wver:\"1.1.4\",wtype:\"dfp\",key:\"413d6640-3b5a-46e6-95a6-410d1759d4c2\",meta:{adup:\"%%ADUNIT%%\",dest:\"%%DEST_URL_ESC%%\",w:\"%%WIDTH%%\",h:\"%%HEIGHT%%\",li:\"%eaid!\",adv:\"%eadv!\",ord:\"%ebuy!\",cr:\"%ecid!\",ygIds:\"%_ygIds!\",aduid:\"%epid!\",haduid:\"%esid!\",isAfc:\"%_isAfc!\",isAmp:\"%_isAmp!\",qid:\"%qid!\",cust_imp:\"aa2d6add-056d-450d-80ab-e9bfeefdfe7e-2886075468\",cust1:\"397648381\",cust2:\"2419\",cust3:\"0\",caid:\"%caid!\",di:\"40\",dn:\"Manage.com-Display\",dcid:\"1333079\",pid:\"1efc6603710003ea\",pn:\"PubNative\",adElId:\"%_adElId!\"},sp:\"dfp\",cfg:{},pbAdId:\"%%PATTERN:hb_adid%%\",pbAdIdAst:\"%%PATTERN:hb_adid_appnexusAst%%\",pbBidder:\"%%PATTERN:hb_bidder%%\",hbPb:\"%%PATTERN:hb_pb%%\",hbCid:\"%_hbcid!\",site:\"%%SITE%%\",pimp:\"%_pimp%\",isHb:\"%%isHb%%\"};window.grumi=s}();</script><template style=\"display: none;\" id=\"template0\"><xmp style=\"display: none;\" id=\"xmp0\"><a href=\"https://omax.admarvel.com/rtb/ck?p=__pid%3D1efc6603710003ea__sid%3D232960%7C232961%7C75004__bid%3D1482830%7C986411%7C986411__cb%3Daa2d6add-056d-450d-80ab-e9bfeefdfe7e-2886075468__h%3D1590692690__rbid%3D40__ek%3D9f1ef43e60283f13ea2cea2d0517313d_20200528_19%3Ab360808a17a003b853b49d8d3dfd76e9_20200528_19__r%3DUS5vd3RYVyN4LlBSd3ZVfG8udnZ0dngjUy5vdU90UnxRLm93dFhXI3guUFJ3dlU%3D__s%3Dbecb5308710c704b1e2db2f3c89fca56__appid%3D4597f7f3b7d34be20ebbc6e8cdcc45f8__crid%3D1333079__cid%3D2419__secure%3D1__maxdest%3Dhttps%253A%252F%252Ft.manage.com%252F44035%253Fbts%253D1590692690%2526pt%253Dapp%2526pi%253D4597f7f3b7d34be20ebbc6e8cdcc45f8%2526p%253DTalkatone%25253A%252BWiFi%252BText%252B%252526%252BCalls%2526pb%253DPubNative%2526pbi%253D1efc6603710003ea%2526bnd%253D397648381%2526sz%253D1%2526city%253DBrooklyn%2526country%253DUSA%2526bip%253D1814634462%2526isp%253DVerizon%252BFios%2526netspd%253Dwifi%2526model%253DiPhone%2526sk%253D0%2526os%253DiOS%2526osv%253D13.3.1%2526region%253DNY%2526zip%253D11201%2526dma%253D501%2526si%253D47%2526_uh%253Difa%25253Afd18721d-b47d-4e25-bf48-a5fb8d94376a%2526bidid%253DZAvApTIErJVwiBzNP-jXDwzN-S0%2526atb%253D41%2526sub4%253D335-b%2526sub9%253D%2526host%253Dweb349-east%2526sdkv%253D%2526lt%253D15.4%2526ff%253D%25253F%2526dvmo%253DiPhone%2526sl%253D679%2526ss%253D1590692011%2526l%253Den%2526uhgid%253D34%2526at%253D1%2526rw%253D0%2526acat%253DSocial%252BNetworking%2526pr2%253D0.263%2526g4%253D0%2526g4c%253D0%2526u14%253D159925%2526u15%253D0%2526u16%253D-1%2526u18%253D0%2526u19%253D0%2526u12%253D1%2526u01%253D2%2526u03%253D2%2526u09%253D1%2526u11%253D1%2526u07%253D1%2526u08%253D1%2526u10%253D1%2526u02%253D2%2526u04%253D2%2526u05%253D1%2526u06%253D1%2526ai%253D1333079%2526ag%253D41255%2526ci%253D2419%2526rt%253D0%2526cu%253DUSD%2526bid%253D0.00044%2526pr%253D1%2526dealid%253D%2526mi1%253D260967%2526mi2%253D260969%2526mi3%253D260971%2526mi4%253D260715%2526u17%253D1%2526mp1%253D0.00484%2526mp2%253D0.00159%2526mp3%253D6.0E-5%2526tr%253D0.73245%2526rm%253D3%2526rd%253D0%2526uimp%253D5%2526uclk%253D0%2526uins%253D0%2526timp%253D159614%2526u20%253D0%2526tclk%253D0%2526tins%253D0%2526useg%253D0%2526u21%253D0%2526u22%253D0%2526mid%253D260969%2526cm%253D2%2526pr1%253D2%2526vte%253D1%2526ece%253D0\"><img src=\"https://cdn.manage.com/2419/031820_Brand_EveryFlavorWelcome_NoPromo_US_STA_Contactless_300x250_03.jpg\" width=\"300\" height=\"250\"></a><img height=\"1\" width=\"1\" src=\"https://gum.criteo.com/sid/pixel?idfa=fd18721d-b47d-4e25-bf48-a5fb8d94376a&displayid=manage_47_ZAvApTIErJVwiBzNP-jXDwzN-S0&origin=display&arbitrageId=ZAvApTIErJVwiBzNP-jXDwzN-S0&cb=1590692690.6129\"></xmp></template><script type=\"text/javascript\" nonce=\"!footerNonce!\">!function(t){var o=window.grumi.key,r=window.grumi,e=r&&r.wtype&&\"gpt\"===r.wtype,n=window.onerror,i=1*new Date,a=navigator.userAgent&&navigator.userAgent.match(/\\b(MSIE |Trident.*?rv:|Edge\\/)(\\d+)/),w=e&&!a;function d(){var e=function(){for(var e,n=document.getElementsByTagName(\"template\"),t=n.length-1;0<=t;t--)if(\"template0\"===n[t].id){e=n[t];break}return e}();return e.content?e.content.getElementById?e.content.getElementById(\"xmp0\"):e.content.childNodes[0]:e.getElementsByTagName(\"xmp\")[0]}function u(){var e=d();return e&&e.innerHTML}function c(e,n){n=n||!1,top.postMessage&&top.postMessage({evType:e||\"\",key:r.key,adup:r.meta.adup,html:window.grumi?window.grumi.tag:\"\",el:r.meta.adElId,refresh:n},\"*\")}var m=!1;function g(e,n){if(!m){m=!0;var t=\"\",o=a&&\"complete\"===document.readyState;window.grumi&&(window.grumi.fsRan=!0,t=window.grumi.tag),o||(t||(t=u()),w&&window.document.open(),window.document.write(t),window.document.close()),((n=n||!1)||o)&&c(e,o)}}function l(e,t){return function(){var n=setTimeout(function(){var e=document.getElementById(i);e&&null===function(e){if(void 0!==e.nextElementSibling)return e.nextElementSibling;for(var n=e.nextSibling;n&&1!==n.nodeType;)n=n.nextSibling;return n}(e)&&t&&t(),clearTimeout(n)},e)}}l(5e3,function(){g()})(),l(2e3,function(){c(\"slwCl\")})(),window.grumi.tag=u(),window.grumi.scriptHost=t,window.grumi.pbGlobal=window.grumi.cfg&&window.grumi.cfg.pbGlobal||\"pbjs\",window.grumi.onerror=n,window.parent&&window.parent.postMessage&&window.parent.postMessage({iw:!0,key:r.key,adup:r.meta.adup,el:r.meta.adElId},\"*\"),function(){var e=document.createElement(\"script\");e.type=\"text/javascript\",e.src=t+o+\"/grumi.js\",e.className=\"rm\",e.id=i,w&&(e.async=!0);var n=\"_\"+1*new Date;window[n]=function(){g(\"netErr\",!0)},window.grumi.start=1*new Date;try{window.document.write(e.outerHTML.replace('class=\"rm\"','onerror=\"'+n+'();\"'))}catch(e){g()}}(),window.onerror=function(e){\"function\"==typeof n&&n.apply(this,arguments),l(0,g)(),window.onerror=n}}((\"http\"===window.location.protocol.substr(0,4)?window.location.protocol:\"https:\")+\"//rumcdn.geoedge.be/\");</script></div><script type=\"text/javascript\" src=\"https://q.adrta.com/s/acl/aa.js?cb=1590692690617#acl;paid=acl;publisherId=PubNative;caid=2419;plid=1333079;siteId=232960;pricePaid=0.44;kv1=300x250;kv2=397648381;kv3=f93851ef1d10bc13835d901db15fc4b3c331d48e;kv4=108.41.31.222;kv7=Manage.com-Display;kv11=aa2d6add-056d-450d-80ab-e9bfeefdfe7e-2886075468-f93851ef1d10bc13835d901db15fc4b3c331d48e;kv12=1333079;kv16=40;kv17=-73;kv18=397648381;kv19=FD18721D-B47D-4E25-BF48-A5FB8D94376A;kv20=;kv26=iOS;kv27=Mozilla/5.0 (iPhone; CPU iPhone OS 13_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148;kv28=Apple_iPhone;kv24=Mobile_InApp\"></script><img src=\"https://omax.admarvel.com/rtb/view?p=__pid=d2f2a857ae10beab__sid=229417__bid=1926699__cid=648680__h=1590692690__btag=2__appid=4597f7f3b7d34be20ebbc6e8cdcc45f8__secure=1__rbid=40\" width=\"1\" height=\"1\" /><img src=\"https://adcolony-east-bidder.manage.com/2/win?_ei=44031&_cost1000=0.44&bts=1590692690&pt=app&pi=4597f7f3b7d34be20ebbc6e8cdcc45f8&p=Talkatone%3A+WiFi+Text+%26+Calls&pb=PubNative&pbi=1efc6603710003ea&bnd=397648381&sz=1&city=Brooklyn&country=USA&bip=1814634462&isp=Verizon+Fios&netspd=wifi&model=iPhone&sk=0&os=iOS&osv=13.3.1&region=NY&zip=11201&dma=501&si=47&_uh=ifa%3Afd18721d-b47d-4e25-bf48-a5fb8d94376a&bidid=ZAvApTIErJVwiBzNP-jXDwzN-S0&atb=41&sub4=335-b&sub9=&host=web349-east&sdkv=&lt=15.4&ff=%3F&dvmo=iPhone&sl=679&ss=1590692011&l=en&uhgid=34&at=1&rw=0&acat=Social+Networking&pr2=0.263&g4=0&g4c=0&u14=159925&u15=0&u16=-1&u18=0&u19=0&u12=1&u01=2&u03=2&u09=1&u11=1&u07=1&u08=1&u10=1&u02=2&u04=2&u05=1&u06=1&ai=1333079&ag=41255&ci=2419&rt=0&cu=USD&bid=0.00044&pr=1&dealid=&mi1=260967&mi2=260969&mi3=260971&mi4=260715&u17=1&mp1=0.00484&mp2=0.00159&mp3=6.0E-5&tr=0.73245&rm=3&rd=0&uimp=5&uclk=0&uins=0&timp=159614&u20=0&tclk=0&tins=0&useg=0&u21=0&u22=0&mid=260969&cm=2&pr1=2&vte=1&ece=0&acid=aa2d6add-056d-450d-80ab-e9bfeefdfe7e-2886075468\" width=\"1\" height=\"1\" /><img src=\"https://omax.admarvel.com/rtb/view?p=__pid=1efc6603710003ea__sid=232960|232961|75004__bid=1482830|986411|986411__cb=aa2d6add-056d-450d-80ab-e9bfeefdfe7e-2886075468__h=1590692690__rbid=40__ek=9f1ef43e60283f13ea2cea2d0517313d_20200528_19:b360808a17a003b853b49d8d3dfd76e9_20200528_19__r=US5vd3RYVyN4LlBSd3ZVfG8udnZ0dngjUy5vdU90UnxRLm93dFhXI3guUFJ3dlU=__s=becb5308710c704b1e2db2f3c89fca56__appid=4597f7f3b7d34be20ebbc6e8cdcc45f8__secure=1__crid=1333079__cid=2419__preqid=__pth=0__did=__csid=232960__isid=232960__wp=0.33\" width=\"1\" height=\"1\" /><script src=\"https://admarvel.s3.amazonaws.com/js/common/action/ad_tracking/track_ad_viewable_lib.js?cb=aa2d6add-056d-450d-80ab-e9bfeefdfe7e-2886075468\"></script><script id=\"omwViewabilityLoader\">!function(){function p(){OMW.performAction&&OMW.performAction(l,m)}function q(a,b){var c=document.createElement(\"script\");c.addEventListener(\"load\",b),c.src=a,document.getElementsByTagName(\"head\")[0].appendChild(c)}window.OMW=window.OMW||{};var a=\"aa2d6add-056d-450d-80ab-e9bfeefdfe7e-2886075468\";a.indexOf(\"{\")!==-1&&(a=Math.floor(1e5*Math.random()));var b=\"banner\";b.indexOf(\"{\")!==-1?b=\"banner\":\"interstitial\"!==b&&(b=\"banner\");var c=\"WAP\",d=!0;c.indexOf(\"{\")!==-1?d=!0:\"iphone\"===c||\"android\"===c?d=!1:\"WAP\"===c&&(d=!0);var e=\"\",f=document.getElementById(\"omwViewabilityLoader\");if(f&&(f.id=\"\"),d){var g=document.createElement(\"div\");e=\"omw-\"+a,g.id=e,g.style.height=\"0px\",f.parentNode.insertBefore(g,f)}var h=\"https://omax.admarvel.com/rtb/et?d=2Qhd2kJZbQcMv5ZgarWEM6oIdPvhC2IPA6oSHBj7kzaUy03wb1iFmvKIQYUUfUIsalF6Ii1RYPhKf8oVScenDNLIT12KlFOP4aF7HSMobqpT3Mdvyu6Wb1kjWfe9C3kbK9dREyWRPD5bP8iJbdleb1uwxtAR35o27WWqt5Oy9ConykbYfmS5g2xSFmYckHQzV5sqBYhqcRFAlWcepXmqPeZ4iWdwPRZhoLXlwssfP1CUCpwecrd3BIRxgee0fweML6SyaJ6mMBKTMtjcnixqI3eR8s4Q2ppf0QXYiR9tlaWlcRWVYm8AHqL8HJQrY4D3I9DlATC\",i=\"https://omax.admarvel.com/rtb/et?d=hbnB0tPxkR56yEjO31NVOaKCJ5lZ9Zh5k5UCKW9IjM2g25C6lrgyVp6mA1RUJiXYhbjtk9gowyEUopWftp0N5a886sPxB1OpenWSDGpnOtezZXUhF6fCv8DjpSCpFO6W82A0e5NrfT3pXnK2XYIReKeyuuCPNw7MmYTCo7gJyoEAc8gm7oNPpSom6zJc0zBCjd3ArTUPxOyjA8Q4sQDlBalCPJAh20MnMv2dMyI42LYiD4NzHx4dxvrUYiJiXJw2n748WGvzX7nGHKuCnghDAFkrK5N1EFWE2smxSF2yP67xv5NnfPhC7fwbudejA07sBsGjCfRXBFEfwjgZMVpK\",j=\"{event_url_videoviewable}\",k=\"{event_url_videoviewablemeasurable}\",l=\"trackAdViewable\",m={adType:b,mobileWeb:d,pixels:{adViewable:[[h,{percentage:50,duration:1}]],adViewableMeasurable:[i],videoViewable:[[j,{percentage:50,duration:2}]],videoViewableMeasurable:[k]}};if(d)m.adInstanceId=a,m.adElementId=e,m.virtualHeight=50;else{var n=\"\";n.indexOf(\"{\")===-1&&(m.sdkVersionNumeric=parseInt(n))}var o=\"https://admarvel.s3.amazonaws.com/js/common/action/ad_tracking/track_ad_viewable_lib.js\";OMW.performAction?p():q(o,p)}();</script><img src=\"https://omax.admarvel.com/rtb/et?d=2cJMNCOx3iuThIqQWqP67hRxXmIFlbnOlfxnpkVLWPFzX08oBhj8uxYOgFRvKb651xmLtEFetmmR9boVkPHmHW0m9eIdmpyUPXuJHngMKguacAlcwnAwOZAdCS8eMgb2cKwii4BuQ06yiadYvESivYeqteldcuJsJUXFb70sqzwLGEbPeh0bUtOd93d11qTBES1hRD4IylriVUxx8hWN9s7nNHocdhLvEiLEOSZvOAanZIABP33030ZrCJfnsLWc5Vj51iagF7MM5owzFrBkGwgPob71AgeYUxDnviCQAJ3CoBZpgnbrtGmiOBJ2lC8\" height=\"1\" width=\"1\">",
  "adomain": ["doordash.com"],
  "attr": [4],
  "bundle": "719972451",
  "cid": "40_2419",
  "crid": "40_1333079",
  "ext": {
    "brid": "2MPU22RN2YFG3UVM",
    "himp": ["https://1x1.a-mo.net/hbx/himp?A=pubnative&B=18219&C=40_1333079&D=FD18721D-B47D-4E25-BF48-A5FB8D94376A&a=__catch_all__&ai=3097&aid=_mlgcb5u6&aud=ao77b72b0259&b=397648381&bid=e1c8676548254d45a6b8fd3e004b0ed8&c2=doordash.com&cn=&ct=0&h=50&i=0&mid=jxjqi5rgta&np=0.264&p=0.264&pp=2640&r=1500&v=ios-1.7.17-338b1ce&w=320&wv=aas-0.1.0"],
    "lid": 18219,
    "sbid": null
  },
  "id": "e1c8676548254d45a6b8fd3e004b0ed8",
  "impid": "1",
  "nurl": "https://got.pubnative.net/dspv1/winnotice?ap=${AUCTION_PRICE}&t=YV1JgGdT8vL2xbWwaMaeMEaJYunaAJ7STsid3OSii9edDlYF1RwWnmMq6TBENtVyPSV2HA9ul4Sm1w0ZkJKD910sFerIPApqMYyJt9mEN_4vKZdX8voVFQXq8Sghjp1_OEnfj91xR5v91GJo2Nvmdb7AvMqikqb1CVk4VMwnOQ",
  "price": 0.264
};


describe('selfclosing', () => {
  xit('Handles closed self-closing tags that\'re closed.', done => {
    wc.compare(
      new Html(`
        <div id="first" style="background: red; padding: 5px">
          <embed></embed>
          <div id="second" style="background: yellow">Should be yellow in red box, right?</div>
        </div>
      `)
    ).then(r => expect(r).to.be.ok()).always(done);
  });

  it('Can handle XMP etc..', done => {
    wc.compare(
      sampleBid.adm
    ).then(r => {
      expect(r).to.be.ok();
    }).always(done);
  });

  it('Handles broken HTML', done => {
    wc.compare(
      '<div>Example <br \\="" /> Hello World</div><h1>Ok</h1>'
    ).then(r => {
      expect(r).to.not.be.ok();
    }).always(done);
  });

  it('Handles closed self-closing tags that\'re closed w/ a slash.', done => {
    wc.compare(
      '<div><object><param name="allowFullScreen" value="true" /><param></param></object></div>'
    ).then(r => expect(r).to.be.ok()).always(done);
  });

});

